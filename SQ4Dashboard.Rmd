---
title: "311 Service Requests Dashboard"
author: "Astrid Barreras"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
#for creating this interactive dashboard
library(flexdashboard)

#for deployment of dashboard as a web app
library(shiny)

#for data manipulation needed
library(dplyr)

#for generating visualizations 
library(ggplot2)

#for adding interactivity to visualizations
library(plotly)

#for plotting correlations
library(corrplot)


#reading in the merged dataset
merged_sum <- read.csv("data/processed/merged_datasets.csv")
```

# Project Overview

**Overarching Question**

How do 311 service request volume, response times, and resolution rates between 2019-2024 vary across NYC boroughs, and to what extent can variations be explained by differences in socioeconomic status and funding allocations?

**Data Sources**

-   [NYC Open Data 311 Service Requests (2019–2024)](https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9/about_data)

-   [American Community Survey (5-year)](https://www.rdocumentation.org/packages/tidycensus/versions/1.7.3)

-   [NYC Agency Expense Budgets](https://data.cityofnewyork.us/City-Government/Expense-Budget-Funding-All-Source/39g5-gbp3/about_data)

**Purpose**

This was a final project for [MS in Business Analytics - Zicklin School of Business](https://zicklin.baruch.cuny.edu/academic-programs/graduate/ms/online-msba/) specifically STA 9750 Software Tools for Data Analysis.

Special thanks to Professor Weylandt for his guidance throughout this semester and feedback throughout the project process.

# Trends

## Inputs {.sidebar}

```{r}
#this will be in a sidebar (.sidebar)
#creating an input widget
#inputId set to borough for selecting later (input$borough)
selectInput(inputId = "borough",
            
            #label displayed (above the dropdown for boroughs)
            label = "Select Borough", 
            
            #getting the unique values of the borough for dropdown
            choices = unique(merged_sum$borough),
            
            #default borough
            selected = "BRONX")

#displays the selected borough
#will show the selected boroughs name through concatenation (label + input)
renderText({paste("Current Borough:", 
                  input$borough)})

#creating a download button to download to download the merged dataset
downloadButton("downBtn", "Download CSV")
```

```{r}
#definign function to create plots for trends 
#passing arguments for the dataset, borough input, outcome, title, ylab (axis title)
plotly_trend <- function(df, 
                         borough_input, 
                         outcome, 
                         title, 
                         ylab) {
  #for interactivity
  ggplotly(df %>%
             
             #filtering for the borough from the input
             filter(borough %in% borough_input) %>%
             
             #setting x-axis as year column
             ggplot(aes(x = year, 
                        
                        #setting y-axis as outcome variable 
                        y = .data[[outcome]], 
                        
                        #setting the color lines by borough
                        color = borough)) +
             
             #drawing this as a trend line
             geom_line() +
             
             #adding points for each year
             geom_point() +
             
             #setting the labs
             labs(
               
               #title as the title to be passed
               title = title,
               
               #x-axis lable as year
               x = "Year",
               
               #y-axis label to be passed
               y = ylab) +
             
             #setting theme as minimal
             theme_minimal())}
```

## Row {.tabset}

### 311 Volume by Agency

```{r}
#wrapping plot in renderPlotly to render plot using shiny app
renderPlotly({
  
  #setting df as the read in df 
  plotly_trend(df = merged_sum,
              
               #setting the input as the borough selected
               borough_input = input$borough,
               
               #setting outcome outcome
               outcome = "volume",
               
               #setting the prefix for title
               #suffix is the borough selected
               title = paste("311 Volume -", input$borough),
               
               #setting the y-axis title 
               ylab = "Total Requests")})
```

## Row {.tabset}

### Mean Response Time (Days) {.tabset}

```{r}
#wrapping plot in renderPlotly to render plot using shiny app
renderPlotly({
  
  #setting df as the read in df 
  plotly_trend(df = merged_sum,
               
               #setting the input as the borough selected
               borough_input = input$borough,
               
               #setting outcome as mean response
               outcome = "mean_response",
               
               #setting the prefix for title
               #suffix is the borough selected
               title = paste("Mean Response Time -", input$borough),
               
               #setting the y-axis title 
               ylab = "Response Time (Days)")})
```

## Row {.tabset}

### Resolution Rate

```{r}
#wrapping plot in renderPlotly to render plot using shiny app
renderPlotly({
  
  #setting the input as the borough selected
  plotly_trend(df = merged_sum,
               
               #setting the input as the borough selected
               borough_input = input$borough,
               
               #setting outcome as resolution rate
               outcome = "resolution_rate",
               
               #setting the prefix for title
               #suffix is the borough selected
               title = paste("Resolution Rate -", input$borough),
               
               #setting the y-axis title 
               ylab = "Resolution Rate")})
```

```{r}
#referring to the selected borough from plot
#producing a text string to display the output
output$selected_borough <- renderText({
  
  
  
  #setting the suffix for the label text
  #referring to the selected borough from plot
  #converting vector to string
  paste("Current Borough:", paste(input$borough, collapse = ", "))})



  #converting the logic of the download buttong for the server
  output$downBtn <- downloadHandler(
  
  
  #setting the file name downloaded 
  filename = function() {
    "data/processed/merged_acs5.csv"},
  
  
  #writing the content of the merged dataset read in to file
  content = function(file) {
    write.csv(merged_sum, file, row.names = FALSE)})
```

# Project Focus

### Specific Question

What effect do SES indicators and budgets have on 311 service requests volume, response times, and resolution rates?

### Data Cleaning​

-   **Service Requests:** Removed missing rows (borough and closed date) and filtered for NYC boroughs (Bronx, Brooklyn, Manhattan, Queens, Staten Island). Removed negative and extreme days to close prior at the borough x agency x year level prior to final calculation of outcomes at the borough x year level. Calculated total volume, response times, and resolution rates per borough x year.

-   **Agency Budgets**: Transformed agency-specific fiscal year budgets to calendar year for alignment across datasets. Filtered budget agencies for those in 311 service requests (with actual budgets) prior to summarizing budgets per year.

-   **SES Indicators:** Mapped ACS5 to 2019-2024 (LOCF for 2024).​

-   **Merging**: Combined 311 outcome data with borough-level SES indicators borough x year and then joined budgets to years. ​

### **Methods**

**Correlations**

-   Visualized the correlations between borough-level SES indicators, budgets and 311 outcomes.​

**Models​**

-   **Relationships:** Tested the linear (LM) and nonlinear effects (GAM) of budgets and borough-level SES indicators (ACS5) on 311 outcomes.

-   **Formulas**:

    -   **LM:** outcome \~ SES + budget​

    -   **GAM**: outcome \~ s(SES) + s(budget)​

### **Overall Findings**

-   **Volume**

    -   Budgets have positive highly statistically significant linear and nonlinear effects on volume. Given that adopted agency budgets are informed by previous year performance, this could signal that increased demand in previous years drive the need for increases in funding.

    -   Unemployment has positive very statistically significant linear effects on volume. This could be due to periods of economic hardship, suggesting that as economic strain rises, so does the demand for reporting public service issues.

-   **Response Time**

    -   Budgets have positive statistically significant linear and statistically significant nonlinear effects on response times. Given that budgets are also statistically significant with volume, potentially in response to previous year performance, workloads potentially have increased as well, signalling an increase in response times (more workload means less capacity).

-   **Resolution Rate**

    -   Budgets have negative statistically significant linear effects on resolution rates. This could be that although budgets are increasing, there may be allocation issues corresponding to the ability to resolve service requests.

    -   Unemployment has positive very statistically significant linear effects on resolution rates. This could be due to the capacity of individuals who file service complaints to engage with the process of resolving their service requests.

    -   Median income has positive statistically significant linear effects on resolution rates. This could be due to individuals who are more affluent having higher political and social capital leading to higher expectations of service delivery.

    -   Total population has negative very statistically significant linear effects on resolution rates. This could be due to the growth of demand in service requests outpacing the capacity to address them.

# Correlations

```{r}
#wrapping plot in renderPlotly to render plot using shiny app
renderPlotly({
  
  #define a variable to hold the columns to pass for correlation
  corr_mat <- merged_sum %>%
    
    #select the columns
    select(volume, mean_response, resolution_rate,
           budget, starts_with("estimate_")) %>%
    
    #computing correlations ensuring pairs use of only non-missing values 
    cor(use = "pairwise.complete.obs")
  
#plot the correlations interactively with plot_ly
  plot_ly(
    
    #setting x as the column names (the variables)
    x = colnames(corr_mat),
    
    
    #setting y as the column names (the variables)
    y = rownames(corr_mat),
    
    #setting z correlations calculated
    z = corr_mat,
    
    #setting plot type as heatmap
    type = "heatmap",
    
    #setting the color scheme
    colorscale = "RdYlBu")})
```

# Volume

### Linear Model

The linear model (volume \~ SES + budget) explains 97.1% of the variance in volume in NYC boroughs between 2019-2024. The model is statistically significant overall (F-test p \< 0.001), indicative that the predictors in the model do explain collectively the variations in volume.

The linear model under-predicted volume by 118953 service requests and over-predicted by 97035 service requests. On average, the linear model is about 44734 (RMSE) service requests from the true total volume.

-   **Total Population (Negative, Not Statistically Significant p \<0.78)**

    -   For every one-unit increase in total population, holding all other predictors constant, the model predicts an decreases by \~1.792e-02 service requests in volume.

-   **Poverty (Positive, Marginally Statistically Significant​ p = 0.06)**

    -   For every one-unit increase in poverty, holding all other predictors constant, the model predicts an increases by \~2.356e+00 service requests in volume.

-   **Median Income (Positive, Not Statistically Significant p = 0.16)**

    -   For every one-unit increase in median income, holding all other predictors constant, the model predicts an increases by \~ 1.496e+00 service requests in volume.

-   **Unemployment (​Positive, Very Statistically Significant​ p \<0.001)**

    -   For every one-unit increase in unemployment, holding all other predictors constant, the model predicts a increases by \~ 7.404e+00 service requests in volume.

-   **Budget (Positive, Highly Statistically Significant p \<0.001)**

    -   For every one-unit increase in budget, holding all other predictors constant, the model predicts an increases by \~ 1.431e-05 service requests in volume.

### GAM Model

The GAM model (volume \~ s(SES) + s(budget)) explains 97.4% of the variance in volume in NYC boroughs between 2019-2024. On average, the GAM model is about 42136 (RMSE) service requests from the true total volume.

-   **Total Population (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.939).

-   **Poverty (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.420).

-   **Median Income (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.276).

-   **Unemployment (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and weakly statistically significant (p = 0.340).

-   **Budget (Highly Statistically Significant, Nonlinear Effects)**

    -   Estimated effect is nonlinear (edf \~ 2.047), and highly statistically significant (p \< 0.001).

# Response Time

### Linear Model

The linear model (response_time \~ SES + budget) explains 30.1% of the variance in average response times in NYC boroughs between 2019-2024. The model is not statistically significant overall (F-test p = 0.105), indicative that the predictors in the model do not collectively explain the variations in response time.

The linear model under-predicted response times by 3.4 days and over-predicted by 2.2 days. On average, the linear model is about 1.4 days from the true response time (RMSE).

-   **Total Population (Positive, Not Statistically Significant p = 0.84)**

    -   For every one-unit increase in total population, holding all other predictors constant, the model predicts response times increases by \~ 4.114e-07 days.

-   **Poverty (Positive, Not Statistically Significant p =0.53​)**

    -   For every one-unit increase in poverty, holding all other predictors constant, the model predicts response times increases by \~ 2.461e-05 days.

-   **Median Income (Positive, Not Statistically Significant p = 0.16)**

    -   For every one-unit increase in median income, holding all other predictors constant,the model predicts average times increases by \~ 4.783e-05 days.

-   **Unemployment (​Negative, Not Statistically Significant​ p =0.73)**

    -   For every one-unit increase in unemployment, holding all other predictors constant, the model predicts response times decreases by \~2.021e-05 days.

-   **Budget (Positive, Statistically Significant p \<0.05)**

    -   For every one-unit increase in budget, holding all other predictors constant,the model predicts response times increases by \~ 1.818e-10 days.

### GAM Model

The GAM model (response_time\~ s(SES) + s(budget)) explains 44.2% of the variance in response time in NYC boroughs between 2019-2024. On average, the GAM model is about 1.3 days (RMSE) from the true average response time.

-   **Total Population (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.979).

-   **Poverty (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.935).

-   **Median Income (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.624).

-   **Unemployment (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.973).

-   **Budget (Statistically Significant, Nonlinear Effects)**

    -   Estimated effect is nonlinear (edf \~ 2.225), and highly statistically significant (p \< 0.05).

# Resolution Rate

### Linear Model

The linear model (resolution_rate \~ SES + budget) explains 57.8% of the variance in average response times in NYC boroughs between 2019-2024. The model is statistically significant overall (F-test p \< 0.001), indicative that the predictors in the model do collectively explain the variations in resolution rates.

The linear model under-predicted resolution rates by \~ 1.269e-03 and over-predicted by \~ 1.014e-03. On average, the linear model is about 0.0005 (RMSE) from the true resolution rate.

-   **Total Population (Negative, Very Statistically Significant p \<0.001)**

    -   For every one-unit increase in total population, holding all other predictors constant, the model predicts resolution rates decreases by \~ -2.812e-09.

-   **Poverty (Positive, Marginally Statistically Significant p = 0.09​)**

    -   For every one-unit increase in poverty, holding all other predictors constant, the model predicts resolution rates increases by \~2.337e-08.

-   **Median Income (Positive, Statistically Significant p \<0.05)**

    -   For every one-unit increase in median income, holding all other predictors constant, the model predicts resolution rates increases by \~2.638e-08.

-   **Unemployment (​Positive, Very Statistically Significant p \<0.01​)**

    -   For every one-unit increase in unemployment, holding all other predictors constant, the model predicts resolution rates increases by \~6.202e-08.

-   **Budget (Negative, Statistically Significant p \<0.05)**

    -   For every one-unit increase in budget, holding all other predictors constant, the model predicts resolution rates decreases by \~7.387e-14.

### GAM Model

The GAM model (volume \~ s(SES) + s(budget)) explains 58.3% of the variance in resoluton rates in NYC boroughs between 2019-2024. On average, the GAM model is about 0.005 (RMSE percentage points from the resolution rates.

-   **Total Population (Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and is statistically significant (p \< 0.05)

-   **Poverty (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.212).

-   **Median Income (Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and is statistically significant (p \< 0.05)

-   **Unemployment (Not Statistically Significant, No Nonlinear Effects)**

    -   Estimated effect is not nonlinear (edf \~ 1), and not statistically significant (p = 0.104).

-   **Budget (Statistically Significant, Nonlinear Effects)**

    -   Estimated effect is nonlinear (edf \~ 1.15), and is statistically significant (p \< 0.05).
